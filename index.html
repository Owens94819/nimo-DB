<!DOCTYPE html>
<html>
  <head>
    <script src="nimo-DB_v0.2.js" type="text/javascript" charset="utf-8"></script>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="" content="">
    <style type="text/css" media="all">
file{
  display: flex;
  flex-direction: column;
  height: 50vh;
  overflow: auto;
  
}
li{
  background: #ddd;
 margin: 1px;
  padding: 5px 10px;
}
    </style>
    <title></title>
  </head>
  <body>
   <input type="file"  id=ipt hidden>
   
   <button id=upl onclick="ipt.click()">Backup a file</button>
   <button id=upl onclick="clearAll()">Clear all</button>
   
   <h2>Backed up files:</h2>
   <file id=file>
     <pre id=pre>Nothing here</pre>
   </file>

    <script type="text/javascript" charset="utf-8">
      var db = new NimoDB();
      db.devMode = false;
      
      var d = ['back up','files']
      var log = console.log;

      var res = (e)=>{
        var x = file.children.length;
        if(x<2||e){
          pre.hidden = false;
          var tx = pre.outerHTML;
          file.innerHTML = tx;
        }
      }
      
      var clearAll = async ()=>{
        var op = await db.open(d[0],d[1])
        op.clear();
        var a = await op.getAllItem()
        res(true);
      }
      
      var clear = async (e,z) => {
        var op = await db.open(d[0],d[1])
        op = await op.removeItem(e)
     
        file.removeChild(z)
        res()
      }
      
      var download = (e) => {
        var url;
        var elm = document.createElement('a')
         url = e;
         url = URL.createObjectURL(url);
      //  location.href = url
        elm.download = e.name;
        elm.href = url;
        pre.appendChild(elm)
        elm.click()
        elm.remove()
      }
      
      var clicked = (e) => {
       var x = e.isTrusted?e.pageX:500;
       var elm = e.target;
       e = elm.file;
       if(x<26){
         clear(e.itemName,elm);
       }else{
         download(e.data,elm)
       }
      }
      
      var toElem = (e)=>{
        pre.hidden = true;
        var elm = document.createElement('li')
        elm.innerHTML = e.data.name;
        elm.file = e;
        elm.onclick = clicked;
        file.appendChild(elm)
        file.scrollTop = file.scrollHeight
      };
      
      
      var render = async ()=> {
        var op = await db.open(d[0],d[1]);
        op = await op.getAllItem();
     //   log(op)
        for(var key in op){
          var obj = op[key]
          obj.itemName = key;
           toElem(obj)
        }
      };
      
      
      ipt.onchange = async (e)=> {
        var obj = {}
        e = e.target.files[0]
        ipt.value = "";
        obj.data = e;
          var loc = await db.open(d[0],d[1]);
          var nm = obj.data.name;
          nm = nm+Date.now()
          loc = await loc.setItem(nm,obj)
          obj = loc;
          obj.itemName = nm;
          log(obj)
          toElem(obj)
      }
       
     
      (async function() {
       await db.create(d[0],d[1])
        render();
      })();
      
    </script>
  </body>
</html>
